trigger:
  - master

pool:
  vmImage: ubuntu-latest

variables:
  dockerRegistryServiceConnection: ConnectDockerHub
  imageRepository: k8b8nm
  containerRegistry: nemesys34
  repository: nemesys34/k8b8nm
  kubernetesServiceEndpoint: connectK8SNM
  aksClusterName: K8B8NM

stages:
- stage: docker
  jobs:
  - job: BuildAndPush
    displayName: Build and push
    steps:
    - task: Kubernetes@1
      inputs:
        connectionType: Kubernetes Service Connection
        kubernetesServiceEndpoint: $(kubernetesServiceEndpoint)
        namespace: qal
        command: get
        arguments: deployments
        secretType: dockerRegistry
        containerRegistryType: Azure Container Registry
      name: kube

    - task: Bash@3
      inputs:
        targetType: inline
        script: |
          versionrep=$(curl -sS "https://hub.docker.com/v2/repositories/$(imageRepository)/tags" | jq -r '."results"[0]["name"]')

          versionold=$(echo $KUBE_KUBECTLOUTPUT | jq '.items[1].spec.template.spec.containers[].image' | cut -d: -f2 | sed 's/"//')

          versionnew=$(awk -F\" '/^ver = "[0-9.]+"/{print $2}' azure-vote/main.py)

          echo "##vso[task.setvariable variable=vernew]$versionnew"

          echo "##vso[task.setvariable variable=verrep]$versionrep"

          sed -i 's/{{ version }}/'$versionnew'/g' manifest/vote-app.yml
      displayName: Mise Ã  jour des versions

    - task: Docker@2
      inputs:
        containerRegistry: $(dockerRegistryServiceConnection)
        repository: $(repository)
        command: buildAndPush
        Dockerfile: "**/Dockerfile"
        tags: $(vernew)
      condition: ne(variables['verrep'], variables['vernew'])
      displayName: Build et Push

- stage: QAL_Deployment
  condition: succeeded()
  displayName: Deploy on QAL
  jobs:
  - job: QAL_Deploy
    name: Deploy_Qal
    displayName: Deploy on QAL
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: KubernetesManifest@0
      name: kubeonqal
      displayName: Deploy on QAL
      inputs:
        action: 'deploy'
        kubernetesServiceConnection: $(kubernetesServiceEndpoint)
        namespace: 'qal'
        manifests: '**/kubernetes/qal/*'
    - task: Bash@3
      name: waitingfordeploy
      inputs:
        targetType: 'inline'
        script: 'sleep 30'
    - task: Bash@3
      inputs:
        targetType: 'inline'
        script: |
          exitcode=$(curl -s -o -I -w "%{http_code}" http://brief8.uncia.fr)
          echo "##vso[task.setvariable variable=exit]$exitcode"
    - task: CmdLine@2
      name: chargetest
      condition: eq(variables['exit'], '200')
      inputs:
        script: |
          seq 250 | parallel --max-args 0  --jobs 20 "curl -k -iF 'vote=free' http://brief8.uncia.fr"
    - task: CmdLine@2
      name: waitforcharge
      inputs:
        script: 'sleep 30'
    - task: Kubernetes@1
      inputs:
        connectionType: Kubernetes Service Connection
        kubernetesServiceEndpoint: $(kubernetesServiceEndpoint)
        namespace: 'qal'
        command: 'get'
        useConfigurationFile: true
        configuration: './kubernetes/qal/qal_app.yml'
      name: qalpods
    - task: CmdLine@2
      name: countpod
      inputs:
        script: |
          qalappcount=$(echo $QALPODS_KUBECTLOUTPUT | jq '.items[0].spec.replicas')
          echo $qalappcount
          echo "##vso[task.setvariable variable=countpods]$qalappcount"

    - task: Kubernetes@1
      name: deleteqal
      condition: ne(variables['countpods'],2)
      inputs:
        connectionType: 'Kubernetes Service Connection'
        kubernetesServiceEndpoint: $(kubernetesServiceEndpoint)
        namespace: 'qal'
        command: 'delete'
        arguments: '-f $(System.DefaultWorkingDirectory)/kubernetes/qal/'

    - task: Bash@3
      name: yourverygood
      condition: succeeded()
      inputs:
        targetType: 'inline'
        script: 'echo "QAL DELETION"'

- stage: 'Deploy_canary'
  condition: succeeded()
  displayName: 'Deploy Canary Release'
  jobs:
  - job: 'Deploy_canary'
    displayName: 'Deployment of Canary Release'
    pool:
    vmImage: 'ubuntu-latest'
    steps:
    - task: KubernetesManifest@0
      name: kubeonprodcanary
      condition: succeeded()
      inputs:
      action: 'deploy'
      kubernetesServiceConnection: $(kubernetesServiceEndpoint)
      namespace: 'prod'
      strategy: 'canary'
      percentage: '30'
      manifests: '**/kubernetes/canary/deployment-canary.yaml'

- stage: 'ManualIntervention'
  condition: succeeded()
  displayName: 'In waiting of validation of working canary release'
  jobs:
  - job: 'waitForValidation'
    displayName: Wait for external validation
    pool: server
    timeoutInMinutes: 4320 # job times out in 3 days
    steps:
    - task: ManualValidation@0
      timeoutInMinutes: 1440 # task times out in 1 day
      inputs:
      notifyUsers: |
      simplon.nicolasmarty@gmail.com
      instructions: 'Please validate the build configuration and resume'
      onTimeout: 'resume'

- stage: 'DeployOnProd'
  displayName: 'Deploy on Prod and delete Canary'
  jobs:
  - job: 'Deployonprod'
    displayName: 'Deploy on Prod and delete Canary'
    name: Deploy_Prod
    pool:
    vmImage: 'ubuntu-latest'
    steps:
    - task: Kubernetes@1
      name: deleteprodapp
      inputs:
      connectionType: 'Kubernetes Service Connection'
      kubernetesServiceEndpoint: $(kubernetesServiceEndpoint)
      namespace: 'prod'
      command: 'delete'
      arguments: '-f $(System.DefaultWorkingDirectory)/kubernetes/prod/deploy_app.yml'

    - task: Kubernetes@1
      name: deployprod
      inputs:
      connectionType: 'Kubernetes Service Connection'
      kubernetesServiceEndpoint: $(kubernetesServiceEndpoint)
      namespace: 'prod'
      command: 'apply'
      useConfigurationFile: true
      configuration: '$(System.DefaultWorkingDirectory)/kubernetes/prod/deploy_app.yml'

    - task: Bash@3
      name: yourdeployment
      condition: succeeded()
      inputs:
      targetType: 'inline'
      script: 'echo "DEPLOY TO PROD OK"'

- stage: 'PerformanceTest'
  condition: succeeded()
  dependsOn: 'DeployOnProd'
  displayName: 'Performance Test on Prod'
  jobs:
  - job: 'PerformanceTest'
    name: Testing
    displayName: 'Performance Test on Prod'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: Kubernetes@1
      inputs:
        connectionType: Kubernetes Service Connection
        kubernetesServiceEndpoint: $(kubernetesServiceEndpoint)
        namespace: 'prod'
        command: 'get'
        useConfigurationFile: true
        configuration: '$(System.DefaultWorkingDirectory)/kubernetes/prod/deploy_app.yml'
        name: prodpods

    - task: Bash@3
      inputs:
        targetType: 'inline'
        script: |
          PRODPODS_KUBECTLOUTPUT=$(echo $(prodpods.KubernetesCliOutput) | tr -d '\r')
          prodpodcount=$(echo $PRODPODS_KUBECTLOUTPUT | jq '.items | length')
          echo "Total number of production pods: $prodpodcount"
          if [ "$prodpodcount" -eq "0" ]; then
            echo "Error: No production pods found"
            exit 1
          fi"