trigger:
- master

pool:
  vmImage: ubuntu-latest

variables:
  dockerRegistryServiceConnection: 'ConnectDockerHub'
  imageRepository: 'k8b8nm'
  containerRegistry: 'nemesys34'
  repository: 'nemesys34/k8b8nm'
  kubernetesServiceEndpoint: 'connectK8SNM'
  aksClusterName: 'K8B8NM'

steps:

- task: Kubernetes@1
  inputs:
    connectionType: 'Kubernetes Service Connection'
    kubernetesServiceEndpoint: $(kubernetesServiceEndpoint)
    namespace: 'qal'
    command: 'get'
    arguments: 'deployments'
    secretType: 'dockerRegistry'
    containerRegistryType: 'Azure Container Registry'
  name: 'kube'

- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      versionrep=$(curl -sS "https://hub.docker.com/v2/repositories/$(imageRepository)/tags" | jq -r '."results"[0]["name"]')
      versionold=$(echo $KUBE_KUBECTLOUTPUT | jq '.items[1].spec.template.spec.containers[].image' | cut -d: -f2 | sed 's/"//')
      versionnew=$(awk -F\" '/^ver = "[0-9.]+"/{print $2}' azure-vote/main.py)
      echo "##vso[task.setvariable variable=vernew]$versionnew"
      echo "##vso[task.setvariable variable=verrep]$versionrep"
      sed -i 's/{{ version }}/'$versionnew'/g' manifest/vote-app.yml
  displayName: 'Mise à jour des versions'

- task: Docker@2
  inputs:
    containerRegistry: $(dockerRegistryServiceConnection)
    repository: $(repository)
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'
    tags: $(vernew)
  condition: ne(variables['verrep'], variables['vernew'])
  displayName: 'Build et Push'

- task: KubernetesManifest@0
  inputs:
    action: 'deploy'
    kubernetesServiceConnection: $(kubernetesServiceEndpoint)
    namespace: 'qal'
    manifests: manifest/vote-app.yml
  condition: ne(variables['verold'], variables['vernew'])
  displayName: 'Déploiement sur namespace QAL'

- task: Kubernetes@1
  inputs:
    connectionType: 'Kubernetes Service Connection'
    kubernetesServiceEndpoint: $(kubernetesServiceEndpoint)
    namespace: 'prod'
    strategy: 'canary'
    percentage: '10'
    command: 'apply'
    arguments: '-f manifest/vote-app.yml'
    secretType: 'dockerRegistry'
    containerRegistryType: 'Azure Container Registry'
  displayName: 'Déploiement sur namespace en canary 10 sur PROD'

- job: validate_build
  dependsOn: deploy_and_validate
  timeoutInMinutes: 1440 # task times out in 1 day
  steps:
  - task: ManualValidation@0
    inputs:
      notifyUsers: |
        simplon.nicolasmarty@gmail.com
      instructions: 'Please validate the build configuration and resume'
      onTimeout: 'resume'
  
- task: Kubernetes@1
  inputs:
    connectionType: 'Kubernetes Service Connection'
    kubernetesServiceEndpoint: $(kubernetesServiceEndpoint)
    namespace: 'prod'
    command: 'apply'
    arguments: '-f manifest/vote-app.yml'
    secretType: 'dockerRegistry'
    containerRegistryType: 'Azure Container Registry'
  displayName: 'Déploiement sur namespace PROD GA'
  condition: succeeded('Attente d\'une action utilisateur')